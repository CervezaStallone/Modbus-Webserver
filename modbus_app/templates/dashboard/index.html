{% extends 'base.html' %}

{% block title %}Dashboard - Modbus Webserver{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Controls -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div id="ws-indicator">
        <span class="badge bg-warning">
            <i class="bi bi-circle-fill"></i> Verbinden...
        </span>
    </div>
    <div class="btn-group">
        <button id="editModeBtn" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-pencil"></i> Bewerk Mode
        </button>
        <button id="addWidgetBtn" class="btn btn-sm btn-primary" style="display: none;">
            <i class="bi bi-plus-lg"></i> Widget Toevoegen
        </button>
    </div>
</div>

<!-- Empty State -->
<div id="emptyState" class="text-center py-5" style="display: none;">
    <i class="bi bi-grid-3x3-gap" style="font-size: 4rem; color: #ccc;"></i>
    <h3 class="mt-3 text-muted">Geen widgets</h3>
    <p class="text-muted">Begin met het toevoegen van widgets om je data te visualiseren</p>
    <button class="btn btn-primary btn-lg" onclick="enableEditMode()">
        <i class="bi bi-plus-lg"></i> Eerste Widget Toevoegen
    </button>
</div>

<!-- Dashboard Grid -->
<div id="dashboardGrid" class="dashboard-grid">
    <!-- Widgets will be loaded here -->
</div>

<!-- Quick Add Widget Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Widget Toevoegen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="form-label fw-bold">1. Kies een Register</label>
                    <select class="form-select form-select-lg" id="quickRegisterSelect">
                        <option value="">Selecteer register...</option>
                    </select>
                </div>
                
                <div class="mb-4" id="widgetTypeSection" style="display: none;">
                    <label class="form-label fw-bold">2. Kies Widget Type</label>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="widget-type-card" data-type="value">
                                <i class="bi bi-123" style="font-size: 2rem;"></i>
                                <div class="mt-2">Waarde</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="widget-type-card" data-type="gauge">
                                <i class="bi bi-speedometer2" style="font-size: 2rem;"></i>
                                <div class="mt-2">Gauge</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="widget-type-card" data-type="chart">
                                <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                                <div class="mt-2">Grafiek</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="widget-type-card" data-type="status">
                                <i class="bi bi-toggle-on" style="font-size: 2rem;"></i>
                                <div class="mt-2">Status</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="widgetPreview" style="display: none;">
                    <label class="form-label fw-bold">3. Preview</label>
                    <div class="p-3 border rounded bg-light">
                        <div id="previewContent"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuleren</button>
                <button type="button" class="btn btn-primary" id="saveWidgetBtn" disabled>
                    <i class="bi bi-check-lg"></i> Widget Toevoegen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Widget Settings Modal -->
<div class="modal fade" id="widgetSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Widget Instellingen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="settingsWidgetId">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Titel</label>
                    <input type="text" class="form-control" id="settingsTitle">
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Breedte</label>
                            <select class="form-select" id="settingsWidth">
                                <option value="3">Klein (25%)</option>
                                <option value="4">Klein-Medium (33%)</option>
                                <option value="6" selected>Medium (50%)</option>
                                <option value="8">Groot (66%)</option>
                                <option value="12">Volledig (100%)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Hoogte (px)</label>
                            <input type="number" class="form-control" id="settingsHeight" value="300" min="150" max="800" step="50">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Kleur</label>
                    <div class="d-flex gap-2">
                        <input type="color" class="form-control form-control-color" id="settingsColor" value="#007bff">
                        <input type="text" class="form-control" id="settingsColorText" value="#007bff" readonly>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Minimum Waarde</label>
                            <input type="number" class="form-control" id="settingsMin" step="0.1">
                            <small class="text-muted">Laat leeg voor automatisch</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Maximum Waarde</label>
                            <input type="number" class="form-control" id="settingsMax" step="0.1">
                            <small class="text-muted">Laat leeg voor automatisch</small>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Decimalen</label>
                            <input type="number" class="form-control" id="settingsDecimals" value="2" min="0" max="6">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Eenheid Tonen</label>
                            <select class="form-select" id="settingsShowUnit">
                                <option value="true" selected>Ja</option>
                                <option value="false">Nee</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuleren</button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">
                    <i class="bi bi-check-lg"></i> Opslaan
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 80px;
    }
    
    .widget-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        position: relative;
        min-height: 200px;
    }
    
    .widget-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .widget-chart {
        margin-top: 10px;
    }
    
    .widget-card.editing {
        border: 2px dashed #0d6efd;
        cursor: move;
    }
    
    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .widget-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: #666;
        margin: 0;
    }
    
    .widget-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #0d6efd;
        margin: 10px 0;
    }
    
    .widget-unit {
        color: #666;
        font-size: 1rem;
        margin-left: 5px;
    }
    
    .widget-actions {
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        gap: 5px;
    }
    
    .widget-card.editing .widget-actions {
        display: flex;
    }
    
    .widget-type-card {
        text-align: center;
        padding: 20px;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: white;
    }
    
    .widget-type-card:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .widget-type-card.selected {
        border-color: #0d6efd;
        background-color: #e7f3ff;
        border-width: 3px;
        box-shadow: 0 4px 16px rgba(13, 110, 253, 0.2);
    }
    
    .widget-type-card small {
        display: block;
        margin-top: 5px;
        font-size: 0.75rem;
    }
    
    #ws-indicator .badge {
        font-size: 0.85rem;
        padding: 8px 12px;
    }
</style>
{% endblock %}

{% block extra_js %}
{% csrf_token %}
<script>
// Global state
let editMode = false;
let widgets = [];
let registers = [];
let ws = null;
let quickAddModal = null;
let selectedRegister = null;
let selectedWidgetType = null;
let draggedElement = null;

// Utility functions
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
}

function fetchAPI(url, options = {}) {
    const defaults = {
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        credentials: 'same-origin'
    };
    return fetch(url, { ...defaults, ...options });
}

function showNotification(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// WebSocket Management
function initWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(protocol + '//' + window.location.host + '/ws/dashboard/');
    
    ws.onopen = () => {
        console.log('WebSocket connected');
        updateWSIndicator('connected');
    };
    
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleRealtimeUpdate(data);
    };
    
    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateWSIndicator('error');
    };
    
    ws.onclose = () => {
        console.log('WebSocket disconnected');
        updateWSIndicator('disconnected');
        setTimeout(initWebSocket, 5000);
    };
}

function updateWSIndicator(status) {
    const indicator = document.getElementById('ws-indicator');
    const badges = {
        connected: '<span class="badge bg-success"><i class="bi bi-circle-fill"></i> Verbonden</span>',
        disconnected: '<span class="badge bg-danger"><i class="bi bi-circle-fill"></i> Verbinding verbroken</span>',
        error: '<span class="badge bg-danger"><i class="bi bi-circle-fill"></i> Fout</span>'
    };
    indicator.innerHTML = badges[status] || badges.disconnected;
}

function handleRealtimeUpdate(data) {
    if (data.type === 'register_update') {
        updateWidgetValue(data.register_id, data.value);
    }
}

function updateWidgetValue(registerId, value) {
    // Find all widgets with this register ID
    const widgetElements = document.querySelectorAll(`[data-register-id="${registerId}"]`);
    
    widgetElements.forEach(widgetElement => {
        const widgetId = widgetElement.dataset.widgetId;
        const widgetType = widgetElement.dataset.widgetType;
        const numericValue = parseFloat(value);
        
        if (isNaN(numericValue)) return;
        
        // Get widget settings from global widgets array
        const widget = widgets.find(w => w.id == widgetId);
        const decimals = widget?.decimal_places || 2;
        const showUnit = widget?.show_unit !== false;
        const unit = widget?.config?.unit || widget?.register_unit || '';
        
        // Update chart widgets
        if (chartInstances[widgetId]) {
            const chart = chartInstances[widgetId];
            
            switch (widgetType) {
                case 'gauge':
                    // Calculate percentage for gauge
                    let gaugeValue = numericValue;
                    const yMin = widget?.y_axis_min;
                    const yMax = widget?.y_axis_max;
                    if (yMin !== undefined && yMin !== null && yMax !== undefined && yMax !== null) {
                        const min = parseFloat(yMin);
                        const max = parseFloat(yMax);
                        if (max > min) {
                            gaugeValue = ((numericValue - min) / (max - min)) * 100;
                            gaugeValue = Math.max(0, Math.min(100, gaugeValue));
                        }
                    } else {
                        gaugeValue = Math.max(0, Math.min(100, numericValue));
                    }
                    chart.updateSeries([gaugeValue]);
                    break;
                
                case 'line_chart':
                    // Add new data point and remove oldest
                    const currentData = chart.w.config.series[0].data;
                    currentData.push({ x: new Date().getTime(), y: numericValue });
                    if (currentData.length > 20) {
                        currentData.shift();
                    }
                    chart.updateSeries([{ data: currentData }]);
                    break;
                
                case 'bar_chart':
                    chart.updateSeries([{ data: [numericValue] }]);
                    break;
            }
        }
        
        // Update text display widgets
        const valueElement = widgetElement.querySelector('.widget-value');
        if (valueElement) {
            const firstChild = valueElement.firstChild;
            if (firstChild && firstChild.nodeType === Node.TEXT_NODE) {
                firstChild.textContent = numericValue.toFixed(decimals);
            } else {
                const unitSpan = valueElement.querySelector('.widget-unit');
                const unitDisplay = showUnit && unit ? ` <span class="widget-unit">${unit}</span>` : '';
                valueElement.innerHTML = numericValue.toFixed(decimals) + unitDisplay;
            }
        }
        
        // Update status indicators
        const statusIcon = widgetElement.querySelector('.bi-circle-fill');
        if (statusIcon) {
            statusIcon.className = numericValue > 0 ? 'bi bi-circle-fill text-success' : 'bi bi-circle-fill text-secondary';
            const statusTextEl = widgetElement.querySelector('.text-center .fw-bold');
            if (statusTextEl) {
                statusTextEl.textContent = numericValue > 0 ? 'AAN' : 'UIT';
            }
            const valueTextEl = widgetElement.querySelector('.text-center .text-muted');
            if (valueTextEl) {
                const unit = widgetElement.querySelector('.widget-unit')?.textContent || '';
                valueTextEl.textContent = numericValue.toFixed(2) + ' ' + unit;
            }
        }
    });
}

// Dashboard Management
async function loadDashboard() {
    try {
        const response = await fetchAPI('/api/v1/dashboard-widgets/');
        const data = await response.json();
        widgets = data.results || data;
        
        renderDashboard();
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showNotification('Fout bij laden dashboard', 'danger');
    }
}

function renderDashboard() {
    const grid = document.getElementById('dashboardGrid');
    const emptyState = document.getElementById('emptyState');
    
    // Clean up old chart instances
    Object.values(chartInstances).forEach(chart => {
        try {
            chart.destroy();
        } catch (e) {
            console.warn('Error destroying chart:', e);
        }
    });
    Object.keys(chartInstances).forEach(key => delete chartInstances[key]);
    
    if (widgets.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    grid.style.display = 'grid';
    emptyState.style.display = 'none';
    grid.innerHTML = '';
    
    widgets.forEach(widget => {
        grid.appendChild(createWidgetElement(widget));
    });
}

function createWidgetElement(widget) {
    const div = document.createElement('div');
    div.className = 'widget-card' + (editMode ? ' editing' : '');
    div.dataset.widgetId = widget.id;
    div.dataset.registerId = widget.register;
    div.dataset.widgetType = widget.widget_type;
    
    // Set dynamic width based on widget.width (grid columns)
    const width = widget.width || 6;
    div.style.gridColumn = `span ${Math.ceil(width / 3)}`; // Convert 12-col to our grid
    
    // Set height if specified
    if (widget.height) {
        div.style.minHeight = widget.height + 'px';
    }
    
    const content = renderWidgetContent(widget);
    
    div.innerHTML = `
        <div class="widget-actions">
            <button class="btn btn-sm btn-outline-success" onclick="readRegisterNow(${widget.register})" title="Nu lezen">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="editWidgetSettings(${widget.id})" title="Instellingen">
                <i class="bi bi-gear"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteWidget(${widget.id})" title="Verwijderen">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        ${content}
    `;
    
    // Make draggable in edit mode
    if (editMode) {
        div.draggable = true;
        div.addEventListener('dragstart', handleDragStart);
        div.addEventListener('dragover', handleDragOver);
        div.addEventListener('drop', handleDrop);
        div.addEventListener('dragend', handleDragEnd);
    }
    
    // Initialize chart after element is added to DOM
    setTimeout(() => {
        initializeWidgetChart(widget);
        if (widget.widget_type === 'line_chart') {
            loadHistoricalData(widget);
        }
    }, 100);
    
    return div;
}

// Store chart instances
const chartInstances = {};

async function loadHistoricalData(widget) {
    try {
        const response = await fetchAPI(`/api/v1/registers/${widget.register}/trend_data/?hours=1`);
        const data = await response.json();
        
        const widgetId = `widget-${widget.id}`;
        const chart = chartInstances[widgetId];
        
        if (chart && data && data.length > 0) {
            // Take last 20 points
            const recentData = data.slice(-20);
            const chartData = recentData.map(point => ({
                x: new Date(point.timestamp).getTime(),
                y: point.value
            }));
            
            chart.updateSeries([{ data: chartData }]);
        }
    } catch (error) {
        console.error('Error loading historical data:', error);
    }
}

function initializeWidgetChart(widget) {
    const widgetId = `widget-${widget.id}`;
    const chartContainer = document.getElementById(widgetId);
    
    if (!chartContainer) return;
    
    let value = widget.current_value;
    if (value === null || value === undefined || isNaN(value)) {
        value = 0;
    }
    value = parseFloat(value);
    
    const unit = widget.config?.unit || widget.register_unit || '';
    const decimals = widget.decimal_places || 1;
    const showUnit = widget.show_unit !== false;
    const color = widget.chart_color || '#007bff';
    const yMin = widget.y_axis_min;
    const yMax = widget.y_axis_max;
    
    let options;
    
    switch (widget.widget_type) {
        case 'gauge':
            // Calculate percentage for gauge (0-100)
            let gaugeValue = 0;
            if (yMin !== undefined && yMin !== null && yMax !== undefined && yMax !== null) {
                const min = parseFloat(yMin);
                const max = parseFloat(yMax);
                if (!isNaN(min) && !isNaN(max) && max > min) {
                    gaugeValue = ((value - min) / (max - min)) * 100;
                    gaugeValue = Math.max(0, Math.min(100, gaugeValue)); // Clamp to 0-100
                } else {
                    gaugeValue = 0;
                }
            } else {
                // Default to value as percentage (0-100) if no min/max specified
                gaugeValue = Math.max(0, Math.min(100, value));
            }
            
            options = {
                series: [gaugeValue],
                chart: {
                    type: 'radialBar',
                    height: 250,
                    sparkline: { enabled: true }
                },
                plotOptions: {
                    radialBar: {
                        startAngle: -90,
                        endAngle: 90,
                        track: {
                            background: "#e7e7e7",
                            strokeWidth: '97%',
                            margin: 5
                        },
                        dataLabels: {
                            name: { show: false },
                            value: {
                                offsetY: -2,
                                fontSize: '22px',
                                formatter: function(val) {
                                    // Show actual value, not percentage
                                    const actualValue = value;
                                    const valStr = actualValue.toFixed(decimals);
                                    return showUnit ? valStr + ' ' + unit : valStr;
                                }
                            }
                        }
                    }
                },
                fill: {
                    type: 'solid',
                    colors: [color]
                },
                stroke: { lineCap: 'round' },
                labels: ['Value']
            };
            break;
        
        case 'line_chart':
            // Load historical data for line chart (will be populated via API call)
            options = {
                series: [{
                    name: unit || 'Value',
                    data: [] // Will be populated by loadHistoricalData
                }],
                chart: {
                    type: 'line',
                    height: 200,
                    animations: {
                        enabled: true,
                        easing: 'linear',
                        dynamicAnimation: { speed: 1000 }
                    },
                    toolbar: { show: false },
                    zoom: { enabled: false }
                },
                dataLabels: { enabled: false },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                colors: [color],
                markers: { size: 0 },
                xaxis: {
                    type: 'datetime',
                    labels: { show: false }
                },
                yaxis: {
                    min: yMin !== undefined && yMin !== null ? parseFloat(yMin) : undefined,
                    max: yMax !== undefined && yMax !== null ? parseFloat(yMax) : undefined,
                    decimalsInFloat: decimals,
                    labels: {
                        formatter: function(val) {
                            return val.toFixed(decimals);
                        }
                    }
                },
                legend: { show: false }
            };
            break;
        
        case 'bar_chart':
            options = {
                series: [{
                    name: unit || 'Value',
                    data: [value]
                }],
                chart: {
                    type: 'bar',
                    height: 200,
                    toolbar: { show: false }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        horizontal: false,
                        columnWidth: '50%'
                    }
                },
                colors: [color],
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        const valStr = val.toFixed(decimals);
                        return showUnit ? valStr + ' ' + unit : valStr;
                    }
                },
                xaxis: {
                    categories: [widget.title || 'Value']
                },
                yaxis: {
                    min: yMin !== undefined && yMin !== null ? parseFloat(yMin) : undefined,
                    max: yMax !== undefined && yMax !== null ? parseFloat(yMax) : undefined,
                    decimalsInFloat: decimals
                }
            };
            break;
        
        default:
            return; // No chart for text/status widgets
    }
    
    if (options && typeof ApexCharts !== 'undefined') {
        const chart = new ApexCharts(chartContainer, options);
        chart.render();
        chartInstances[widget.id] = chart;
    }
}

function renderWidgetContent(widget) {
    const title = widget.title || widget.register_name || 'Onbekend';
    let value = widget.current_value;
    
    // Fallback to last_value if current_value is not available
    if (value === undefined || value === null) {
        value = 0;
    }
    
    const unit = widget.config?.unit || widget.register_unit || '';
    const widgetId = `widget-${widget.id}`;
    const decimals = widget.decimal_places || 2;
    const showUnit = widget.show_unit !== false;
    
    switch (widget.widget_type) {
        case 'gauge':
            return `
                <div class="widget-header">
                    <h6 class="widget-title">${title}</h6>
                </div>
                <div id="${widgetId}" class="widget-chart"></div>
            `;
        
        case 'line_chart':
        case 'bar_chart':
            return `
                <div class="widget-header">
                    <h6 class="widget-title">${title}</h6>
                </div>
                <div id="${widgetId}" class="widget-chart" style="height: 200px;"></div>
            `;
        
        case 'text':
        default:
            const displayValue = typeof value === 'number' ? value.toFixed(decimals) : value;
            const unitDisplay = showUnit && unit ? `<span class="widget-unit">${unit}</span>` : '';
            return `
                <div class="widget-header">
                    <h6 class="widget-title">${title}</h6>
                </div>
                <div class="widget-value">
                    ${displayValue}
                    ${unitDisplay}
                </div>
            `;
        
        case 'status':
            const statusColor = (typeof value === 'number' && value > 0) ? 'success' : 'secondary';
            const statusText = (typeof value === 'number' && value > 0) ? 'AAN' : 'UIT';
            const statusValue = typeof value === 'number' ? value.toFixed(decimals) : value;
            const statusUnit = showUnit && unit ? unit : '';
            return `
                <div class="widget-header">
                    <h6 class="widget-title">${title}</h6>
                </div>
                <div class="text-center py-3">
                    <i class="bi bi-circle-fill text-${statusColor}" style="font-size: 3rem;"></i>
                    <div class="mt-2 fw-bold">${statusText}</div>
                    <div class="text-muted">${statusValue} ${statusUnit}</div>
                </div>
            `;
    }
}

// Edit Mode
function enableEditMode() {
    editMode = true;
    document.getElementById('editModeBtn').innerHTML = '<i class="bi bi-check-lg"></i> Klaar';
    document.getElementById('addWidgetBtn').style.display = 'inline-block';
    
    document.querySelectorAll('.widget-card').forEach(card => {
        card.classList.add('editing');
    });
}

function disableEditMode() {
    editMode = false;
    document.getElementById('editModeBtn').innerHTML = '<i class="bi bi-pencil"></i> Bewerk Mode';
    document.getElementById('addWidgetBtn').style.display = 'none';
    
    document.querySelectorAll('.widget-card').forEach(card => {
        card.classList.remove('editing');
    });
}

function toggleEditMode() {
    if (editMode) {
        disableEditMode();
    } else {
        enableEditMode();
    }
}

// Quick Add Widget
async function loadRegisters() {
    try {
        const response = await fetchAPI('/api/v1/registers/');
        const data = await response.json();
        registers = data.results || data;
        
        const select = document.getElementById('quickRegisterSelect');
        select.innerHTML = '<option value="">Selecteer register...</option>';
        
        registers.forEach(reg => {
            const option = document.createElement('option');
            option.value = reg.id;
            option.textContent = `${reg.name} (${reg.device_name})`;
            option.dataset.register = JSON.stringify(reg);
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading registers:', error);
    }
}

function showQuickAdd() {
    selectedRegister = null;
    selectedWidgetType = null;
    document.getElementById('widgetTypeSection').style.display = 'none';
    document.getElementById('widgetPreview').style.display = 'none';
    document.getElementById('saveWidgetBtn').disabled = true;
    quickAddModal.show();
}

async function saveQuickWidget() {
    if (!selectedRegister || !selectedWidgetType) return;
    
    const register = registers.find(r => r.id == selectedRegister);
    
    // Map widget type to model choices
    const typeMap = {
        'value': 'text',
        'gauge': 'gauge',
        'chart': 'line_chart',
        'status': 'status'
    };
    
    const widgetData = {
        title: register.name,
        widget_type: typeMap[selectedWidgetType] || 'text',
        register: selectedRegister,
        width: 6,
        row_position: widgets.length,
        column_position: 0,
        decimal_places: 2,
        show_unit: true
    };
    
    try {
        const response = await fetchAPI('/api/v1/dashboard-widgets/', {
            method: 'POST',
            body: JSON.stringify(widgetData)
        });
        
        if (response.ok) {
            showNotification('Widget toegevoegd!', 'success');
            quickAddModal.hide();
            await loadDashboard();
        } else {
            const errorData = await response.json();
            console.error('Error response:', errorData);
            throw new Error(errorData.detail || 'Failed to save widget');
        }
    } catch (error) {
        console.error('Error saving widget:', error);
        showNotification('Fout bij opslaan widget: ' + error.message, 'danger');
    }
}

async function readRegisterNow(registerId) {
    try {
        const response = await fetchAPI(`/api/v1/registers/${registerId}/read_now/`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            showNotification(`Waarde gelezen: ${data.value}`, 'success');
            // Value will be updated via WebSocket broadcast
        } else {
            const error = await response.json();
            showNotification(error.detail || 'Fout bij lezen', 'danger');
        }
    } catch (error) {
        console.error('Error reading register:', error);
        showNotification('Fout bij lezen van register', 'danger');
    }
}

async function deleteWidget(widgetId) {
    if (!confirm('Widget verwijderen?')) return;
    
    try {
        // Destroy chart instance if exists
        if (chartInstances[widgetId]) {
            chartInstances[widgetId].destroy();
            delete chartInstances[widgetId];
        }
        
        const response = await fetchAPI(`/api/v1/dashboard-widgets/${widgetId}/`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showNotification('Widget verwijderd', 'success');
            await loadDashboard();
        }
    } catch (error) {
        console.error('Error deleting widget:', error);
        showNotification('Fout bij verwijderen', 'danger');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
    quickAddModal = new bootstrap.Modal(document.getElementById('quickAddModal'));
    
    // Event listeners
    document.getElementById('editModeBtn').addEventListener('click', toggleEditMode);
    document.getElementById('addWidgetBtn').addEventListener('click', showQuickAdd);
    document.getElementById('saveWidgetBtn').addEventListener('click', saveQuickWidget);
    
    // Register select change
    document.getElementById('quickRegisterSelect').addEventListener('change', function(e) {
        selectedRegister = e.target.value;
        if (selectedRegister) {
            document.getElementById('widgetTypeSection').style.display = 'block';
        } else {
            document.getElementById('widgetTypeSection').style.display = 'none';
            document.getElementById('widgetPreview').style.display = 'none';
        }
    });
    
    // Widget type selection
    document.querySelectorAll('.widget-type-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.widget-type-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedWidgetType = this.dataset.type;
            
            document.getElementById('widgetPreview').style.display = 'block';
            document.getElementById('saveWidgetBtn').disabled = false;
            
            const register = registers.find(r => r.id == selectedRegister);
            const previewValue = 125.50;
            const unit = register.unit || '';
            
            let previewHTML = '';
            switch(selectedWidgetType) {
                case 'value':
                    previewHTML = `
                        <div style="text-align: center;">
                            <h6 class="text-muted mb-3">${register.name}</h6>
                            <div style="font-size: 3rem; font-weight: bold; color: #0d6efd;">
                                ${previewValue.toFixed(2)} <span style="font-size: 1.5rem; color: #666;">${unit}</span>
                            </div>
                        </div>
                    `;
                    break;
                case 'gauge':
                    previewHTML = `
                        <div style="text-align: center;">
                            <h6 class="text-muted mb-2">${register.name}</h6>
                            <div style="position: relative; width: 150px; height: 150px; margin: 0 auto;">
                                <svg viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="40" fill="none" stroke="#e7e7e7" stroke-width="8"/>
                                    <circle cx="50" cy="50" r="40" fill="none" stroke="#0d6efd" stroke-width="8"
                                            stroke-dasharray="251" stroke-dashoffset="60" 
                                            transform="rotate(-90 50 50)" stroke-linecap="round"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: bold;">
                                    ${previewValue.toFixed(1)} ${unit}
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'chart':
                    previewHTML = `
                        <div style="text-align: center;">
                            <h6 class="text-muted mb-2">${register.name}</h6>
                            <svg viewBox="0 0 200 100" style="width: 100%; height: 100px;">
                                <polyline points="0,80 20,70 40,60 60,50 80,55 100,45 120,40 140,50 160,35 180,30 200,25"
                                          fill="none" stroke="#0d6efd" stroke-width="2"/>
                                <polyline points="0,100 0,80 20,70 40,60 60,50 80,55 100,45 120,40 140,50 160,35 180,30 200,25 200,100"
                                          fill="#0d6efd" fill-opacity="0.1"/>
                            </svg>
                            <div class="mt-2 text-muted small">Live trend (20 punten)</div>
                        </div>
                    `;
                    break;
                case 'status':
                    previewHTML = `
                        <div style="text-align: center;">
                            <h6 class="text-muted mb-3">${register.name}</h6>
                            <i class="bi bi-circle-fill text-success" style="font-size: 4rem;"></i>
                            <div class="mt-2 fw-bold" style="font-size: 1.5rem;">AAN</div>
                            <div class="text-muted">${previewValue.toFixed(2)} ${unit}</div>
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('previewContent').innerHTML = previewHTML;
        });
    });
    
    // Color picker sync
    document.getElementById('settingsColor').addEventListener('input', function(e) {
        document.getElementById('settingsColorText').value = e.target.value;
    });
    
    document.getElementById('saveSettingsBtn').addEventListener('click', saveWidgetSettings);
    
    // Load data
    await loadRegisters();
    await loadDashboard();
    initWebSocket();
});

// Widget Settings Functions
let widgetSettingsModal;

function editWidgetSettings(widgetId) {
    const widget = widgets.find(w => w.id === widgetId);
    if (!widget) return;
    
    if (!widgetSettingsModal) {
        widgetSettingsModal = new bootstrap.Modal(document.getElementById('widgetSettingsModal'));
    }
    
    // Populate form
    document.getElementById('settingsWidgetId').value = widget.id;
    document.getElementById('settingsTitle').value = widget.title || '';
    document.getElementById('settingsWidth').value = widget.width || 6;
    document.getElementById('settingsHeight').value = widget.height || 300;
    document.getElementById('settingsColor').value = widget.chart_color || '#007bff';
    document.getElementById('settingsColorText').value = widget.chart_color || '#007bff';
    document.getElementById('settingsMin').value = widget.y_axis_min || '';
    document.getElementById('settingsMax').value = widget.y_axis_max || '';
    document.getElementById('settingsDecimals').value = widget.decimal_places || 2;
    document.getElementById('settingsShowUnit').value = widget.show_unit ? 'true' : 'false';
    
    widgetSettingsModal.show();
}

async function saveWidgetSettings() {
    const widgetId = document.getElementById('settingsWidgetId').value;
    const settings = {
        title: document.getElementById('settingsTitle').value,
        width: parseInt(document.getElementById('settingsWidth').value),
        height: parseInt(document.getElementById('settingsHeight').value),
        chart_color: document.getElementById('settingsColor').value,
        y_axis_min: parseFloat(document.getElementById('settingsMin').value) || null,
        y_axis_max: parseFloat(document.getElementById('settingsMax').value) || null,
        y_axis_mode: (document.getElementById('settingsMin').value || document.getElementById('settingsMax').value) ? 'static' : 'auto',
        decimal_places: parseInt(document.getElementById('settingsDecimals').value),
        show_unit: document.getElementById('settingsShowUnit').value === 'true'
    };
    
    try {
        const response = await fetchAPI(`/api/v1/dashboard-widgets/${widgetId}/`, {
            method: 'PATCH',
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            showNotification('Instellingen opgeslagen', 'success');
            widgetSettingsModal.hide();
            await loadDashboard();
        } else {
            throw new Error('Failed to save settings');
        }
    } catch (error) {
        console.error('Error saving settings:', error);
        showNotification('Fout bij opslaan instellingen', 'danger');
    }
}

// Drag and Drop Functions
function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    if (draggedElement !== this) {
        const allCards = Array.from(document.querySelectorAll('.widget-card'));
        const draggedIndex = allCards.indexOf(draggedElement);
        const targetIndex = allCards.indexOf(this);
        
        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }
        
        // Update positions in backend
        updateWidgetPositions();
    }
    
    return false;
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.widget-card').forEach(card => {
        card.classList.remove('drag-over');
    });
}

async function updateWidgetPositions() {
    const cards = document.querySelectorAll('.widget-card');
    const updates = [];
    
    cards.forEach((card, index) => {
        const widgetId = card.dataset.widgetId;
        updates.push(
            fetchAPI(`/api/v1/dashboard-widgets/${widgetId}/`, {
                method: 'PATCH',
                body: JSON.stringify({ row_position: index })
            })
        );
    });
    
    try {
        await Promise.all(updates);
        console.log('Widget positions updated');
    } catch (error) {
        console.error('Error updating positions:', error);
    }
}
</script>
{% endblock %}
